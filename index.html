<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FFF8E7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>é—ªç”µå¿«ä¼ </title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="./sloth.png">
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        :root {
            --primary: #2D7CA8; --bg: #FFF8E7; --surface: #FFFFFF;
            --text-main: #3E3228; --text-sub: #8D8176;
            --radius-L: 24px; --radius-M: 16px;
            --shadow-card: 0 4px 12px rgba(62, 50, 40, 0.04);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; color: var(--text-main); }
        .icon { width: 24px; height: 24px; fill: currentColor; }
        
        /* å¯¼èˆªæ  */
        .navbar {
            height: 60px; padding: 0 16px; background: rgba(255, 248, 231, 0.9); backdrop-filter: blur(10px);
            display: flex; justify-content: space-between; align-items: center; z-index: 50; flex-shrink: 0;
        }
        .brand { display: flex; align-items: center; gap: 10px; }
        .logo-crop { width: 38px; height: 38px; border-radius: 50%; overflow: hidden; border: 1px solid rgba(0,0,0,0.1); }
        .app-logo { width: 100%; height: 100%; object-fit: cover; }
        .app-name { font-size: 17px; font-weight: 800; }
        .status-pill { font-size: 11px; padding: 5px 12px; border-radius: 20px; background: rgba(0,0,0,0.05); color: var(--text-sub); font-weight: 600; }
        .status-pill.online { background: #D1F2EB; color: #0E6251; }

        /* ä¸»ç•Œé¢ */
        .main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; padding-bottom: 70px; }
        
        /* æ‹–æ‹½å…¨å±é®ç½© */
        .drag-overlay {
            position: absolute; inset: 0; background: rgba(255,255,255,0.9); z-index: 999; 
            display: none; flex-direction: column; align-items: center; justify-content: center;
            color: var(--primary); font-weight: bold; backdrop-filter: blur(5px);
        }
        .drag-overlay.active { display: flex; }

        .chat-scroll { flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .sys-notice { text-align: center; font-size: 12px; color: var(--text-sub); opacity: 0.6; margin: 10px 0; }

        /* æ¶ˆæ¯æ°”æ³¡ */
        .msg-row { display: flex; width: 100%; margin-bottom: 2px; }
        .msg-row.self { justify-content: flex-end; } .msg-row.peer { justify-content: flex-start; }
        .bubble { max-width: 85%; padding: 10px 14px; border-radius: var(--radius-M); font-size: 15px; background: var(--surface); box-shadow: var(--shadow-card); }
        .msg-row.self .bubble { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .msg-row.peer .bubble { border-bottom-left-radius: 4px; }

        /* æ–‡ä»¶å¡ç‰‡ (æ–°ç‰ˆå¸ƒå±€) */
        .file-card { width: 240px; position: relative; }
        .file-inner { 
            background: var(--surface); border-radius: 12px; padding: 10px; 
            display: flex; align-items: center; gap: 10px; cursor: pointer; /* æ•´ä¸ªå¡ç‰‡å¯ç‚¹(ä¸‹è½½) */
        }
        .msg-row.self .file-inner { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); }
        
        /* ç¼©ç•¥å›¾/å›¾æ ‡å®¹å™¨ */
        .thumb-box { 
            width: 48px; height: 48px; border-radius: 8px; background: #F3F4F6; 
            display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; 
        }
        .thumb-img { width: 100%; height: 100%; object-fit: cover; }
        .msg-row.self .thumb-box { background: rgba(255,255,255,0.2); color: white; }

        .file-info { flex: 1; overflow: hidden; }
        .file-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-meta { font-size: 11px; opacity: 0.8; margin-top: 2px; display: flex; justify-content: space-between; }
        .msg-row.self .file-name, .msg-row.self .file-meta { color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        .progress-bar { height: 3px; background: rgba(0,0,0,0.05); margin-top: 6px; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.2s; }
        .msg-row.self .progress-fill { background: white; }

        /* é¢„è§ˆ/æ’­æ”¾ ç‹¬ç«‹æŒ‰é’® (æ‚¬æµ®åœ¨å³ä¾§) */
        .btn-preview {
            width: 32px; height: 32px; border-radius: 50%; background: var(--primary); color: white;
            border: none; position: absolute; right: -10px; bottom: -10px;
            display: none; align-items: center; justify-content: center; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); cursor: pointer; z-index: 10;
        }
        .btn-preview:active { transform: scale(0.9); }

        /* åº•éƒ¨è¾“å…¥æ  */
        .input-area-wrapper { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); padding: 8px 12px; padding-bottom: max(8px, var(--safe-bottom)); z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.02); }
        .input-bar { display: flex; align-items: center; gap: 8px; height: 44px; }
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; border: none; background: #F2F0EB; color: var(--text-sub); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .btn-voice { flex: 1; height: 40px; border-radius: 20px; background: #F2F0EB; border: none; font-weight: bold; color: var(--text-main); }
        .btn-voice.recording { background: #FF8F66; color: white; }
        #msg-input { flex: 1; height: 40px; border-radius: 20px; background: #F2F0EB; border: none; padding: 0 16px; display: none; }

        /* å¼¹çª— & åŠ è½½åŠ¨ç”»ä¿®å¤ */
        .modal { position: fixed; inset: 0; background: rgba(255,248,231,0.96); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card { width: 85%; max-width: 340px; background: white; padding: 30px 20px; border-radius: 28px; text-align: center; box-shadow: 0 12px 30px rgba(62,50,40,0.08); }
        
        /* å¼ºåˆ¶åœ†å½¢è£åˆ‡ï¼Œè§£å†³ç™½æ¡†é—®é¢˜ */
        .logo-wrapper-crop {
            width: 100px; height: 100px; margin: 0 auto 16px auto;
            border-radius: 50%; border: 4px solid white;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow: hidden; /* ç‰©ç†è£åˆ‡ */
            background: white; animation: float 3s ease-in-out infinite;
        }
        .hero-img { width: 100%; height: 100%; object-fit: cover; }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }

        .id-display { background: #F5F7FA; padding: 10px; border-radius: 10px; margin: 15px 0; font-family: monospace; font-weight: bold; font-size: 18px; }
        .input-id { width: 100%; height: 46px; border-radius: 14px; border: 2px solid #EEE; text-align: center; font-size: 16px; margin-bottom: 15px; outline: none;}
        .btn-block { width: 100%; height: 48px; border-radius: 14px; background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        
        /* ç¯ç®± */
        .lightbox { position: fixed; inset: 0; background: black; z-index: 3000; display: none; align-items: center; justify-content: center; }
        .lightbox.active { display: flex; }
        .lightbox-content { max-width: 100%; max-height: 100%; }
        .btn-close { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.3); width: 36px; height: 36px; border-radius: 50%; border:none; color:white; font-size:24px; z-index: 3001; }

    </style>
</head>
<body>

    <div class="lightbox" id="lightbox" onclick="closeLightbox()">
        <button class="btn-close">Ã—</button>
        <img id="lb-img" class="lightbox-content" style="display:none" onclick="event.stopPropagation()">
        <video id="lb-video" class="lightbox-content" controls style="display:none" onclick="event.stopPropagation()"></video>
    </div>

    <div class="modal" id="modal">
        <div class="card">
            <div class="logo-wrapper-crop">
                <img src="./sloth.png" class="hero-img" alt="Logo">
            </div>
            <h2 style="margin:0; font-size:20px;">é—ªç”µå¿«ä¼ </h2>
            <div id="qr-code" style="margin:20px auto; padding:8px; background:white; border-radius:12px; display:inline-block; min-height:100px;"></div>
            <div class="id-display" id="my-id">ç”Ÿæˆä¸­...</div>
            <input type="text" id="target-id" class="input-id" placeholder="è¾“å…¥å¯¹æ–¹ ID">
            <div id="scanner-box" style="display:none; height:240px; background:black; border-radius:16px; margin-bottom:15px;"><div id="reader" style="width:100%;height:100%"></div></div>
            <div style="display:flex; gap:10px;">
                <button class="btn-block" onclick="toggleScan()" style="flex:1; background:#F2F0EB; color:#333">ğŸ“·</button>
                <button class="btn-block" onclick="connect()" style="flex:2">è¿æ¥</button>
            </div>
        </div>
    </div>

    <div class="navbar">
        <div class="brand">
            <div class="logo-crop"><img src="./sloth.png" class="app-logo"></div>
            <span class="app-name">é—ªç”µå¿«ä¼ </span>
        </div>
        <div class="status-pill" id="status">ç¦»çº¿</div>
    </div>

    <div class="main-container">
        <div class="drag-overlay" id="drag-overlay">
            <div style="font-size:20px">æ¾æ‰‹ å‘é€æ–‡ä»¶</div>
        </div>
        <div style="padding:16px 20px 0 20px;">
            <div id="drop-trigger" style="height:80px; border:2px dashed #E0D6CC; border-radius:24px; display:flex; align-items:center; justify-content:center; color:var(--primary); font-weight:bold; cursor:pointer; background:white;">
                ç‚¹å‡»æˆ–æ‹–æ‹½ å‘é€æ–‡ä»¶
            </div>
        </div>
        <div class="chat-scroll" id="chat-list">
            <div class="sys-notice">V11.0 ç»ˆæäº¤äº’ç‰ˆ</div>
        </div>
    </div>

    <div class="input-area-wrapper">
        <div class="input-bar">
            <button class="btn-circle" onclick="toggleInput()">âŒ¨ï¸</button>
            <button id="btn-voice" class="btn-voice">æŒ‰ä½ è¯´è¯</button>
            <input id="msg-input" type="text" placeholder="è¾“å…¥æ¶ˆæ¯...">
            <button class="btn-circle" onclick="sendText()" id="btn-send" style="display:none; background:var(--primary); color:white;">â¤</button>
            <button class="btn-circle" id="btn-plus" onclick="document.getElementById('file-input').click()">ï¼‹</button>
        </div>
    </div>
    <input type="file" id="file-input" multiple style="display:none">

    <script>
        const App = { id: null, peer: null, conn: null, connected: false, queue: [], isSending: false };
        
        // --- 1. åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => setTimeout(init, 100));

        function init() {
            App.id = localStorage.getItem('sloth_v11') || (Math.floor(Math.random()*9000)+1000).toString();
            localStorage.setItem('sloth_v11', App.id);
            document.getElementById('my-id').innerText = App.id;
            
            const qr = document.getElementById("qr-code");
            if(qr && window.QRCode) new QRCode(qr, { text: App.id, width: 100, height: 100, colorDark: "#2D7CA8", colorLight: "#FFFFFF" });

            if(window.Peer) {
                App.peer = new Peer(App.id, { debug: 1 });
                App.peer.on('open', () => document.getElementById('status').innerText='ç­‰å¾…è¿æ¥');
                App.peer.on('connection', c => { if(confirm('è¿æ¥ ID: '+c.peer+'?')) setupConn(c); });
                App.peer.on('error', e => alert('Err: '+e.type));
            }
        }

        function setupConn(conn) {
            if(App.conn) App.conn.close(); App.conn = conn;
            conn.on('open', () => conn.send({ type: 'handshake' }));
            conn.on('data', handleData);
            conn.on('close', () => location.reload());
        }
        function connect() { const t=document.getElementById('target-id').value.trim(); if(t) setupConn(App.peer.connect(t, {reliable:true})); }

        // --- 2. æ•°æ®å¤„ç†ä¸é€Ÿåº¦è®¡ç®— ---
        let Rx = { buf: [], size: 0, meta: null, lastLoaded: 0, lastTime: 0 };
        
        function handleData(data) {
            if (data.type) {
                if(data.type==='handshake'){ App.connected=true; document.getElementById('modal').style.display='none'; document.getElementById('status').innerText='å·²è¿æ¥'; document.getElementById('status').classList.add('online'); }
                else if(data.type==='text') addMsg(data.text, 'peer');
                else if(data.type==='file-start') { 
                    Rx = { buf:[], size:0, meta:data, lastLoaded:0, lastTime:Date.now() }; 
                    createFileItem(data.id, data.name, data.size, 'peer', data.mime); 
                }
                else if(data.type==='file-end') finishFile(data.id, Rx.meta.mime);
            } else {
                Rx.buf.push(data); Rx.size += data.byteLength;
                
                // æ¥æ”¶ç«¯é€Ÿåº¦è®¡ç®— (500msåˆ·æ–°ä¸€æ¬¡)
                const now = Date.now();
                if(now - Rx.lastTime > 500) {
                    const speed = calcSpeed(Rx.size - Rx.lastLoaded, now - Rx.lastTime);
                    updateProgress(Rx.meta.id, Rx.size, Rx.meta.size, speed);
                    Rx.lastLoaded = Rx.size; Rx.lastTime = now;
                }
            }
        }

        function calcSpeed(bytes, ms) {
            if(ms <= 0) return '';
            const bps = (bytes / ms) * 1000;
            return bps > 1048576 ? (bps/1048576).toFixed(1)+' MB/s' : (bps/1024).toFixed(0)+' KB/s';
        }

        // --- 3. æ‹–æ‹½ä¿®å¤ (documentçº§ç›‘å¬) ---
        const dragOverlay = document.getElementById('drag-overlay');
        let dragCounter = 0;
        
        document.body.addEventListener('dragenter', e => { e.preventDefault(); dragCounter++; dragOverlay.classList.add('active'); });
        document.body.addEventListener('dragleave', e => { e.preventDefault(); dragCounter--; if(dragCounter===0) dragOverlay.classList.remove('active'); });
        document.body.addEventListener('dragover', e => e.preventDefault());
        
        document.body.addEventListener('drop', async e => {
            e.preventDefault(); dragCounter = 0; dragOverlay.classList.remove('active');
            const items = [...e.dataTransfer.items], list = [];
            for (let i of items) {
                const ent = i.webkitGetAsEntry ? i.webkitGetAsEntry() : null;
                if (ent) list = list.concat(await scanEntry(ent));
                else if (i.kind === 'file') list.push(i.getAsFile());
            }
            if(list.length) enqueue(list);
        });
        
        // ç‚¹å‡»è§¦å‘
        document.getElementById('drop-trigger').onclick = () => document.getElementById('file-input').click();
        document.getElementById('file-input').onchange = e => enqueue(e.target.files);

        async function scanEntry(e){ if(e.isFile)return new Promise(r=>e.file(f=>r([f]))); if(e.isDirectory){const r=e.createReader();const ents=await new Promise(res=>r.readEntries(res));let a=[];for(let s of ents)a=a.concat(await scanEntry(s));return a;} return []; }

        // --- 4. å‘é€é€»è¾‘ ---
        function enqueue(files) {
            if(!App.connected) return alert('è¯·å…ˆè¿æ¥');
            Array.from(files).forEach(f => {
                const id = 'f-'+Date.now()+Math.random().toString(36).substr(2);
                createFileItem(id, f.name, f.size, 'self', f.type);
                App.queue.push({f, id});
            });
            process();
        }
        function process() { if(App.isSending || !App.queue.length) return; App.isSending=true; sendFile(App.queue.shift()); }
        
        function sendFile({f, id}) {
            App.conn.send({type:'file-start', id, name:f.name, size:f.size, mime:f.type});
            const reader = new FileReader(); let offset=0; let lastTime=Date.now(); let lastLoaded=0;
            
            const push = () => {
                if(App.conn.dataChannel.bufferedAmount > 65536) { setTimeout(push, 20); return; }
                const slice = f.slice(offset, offset + 32768);
                reader.readAsArrayBuffer(slice);
            };
            
            reader.onload = e => {
                App.conn.send(e.target.result); 
                offset += e.target.result.byteLength;
                
                // å‘é€ç«¯é€Ÿåº¦è®¡ç®—
                const now = Date.now();
                if(now - lastTime > 500 || offset >= f.size) {
                    const speed = calcSpeed(offset - lastLoaded, now - lastTime);
                    updateProgress(id, offset, f.size, speed);
                    lastLoaded = offset; lastTime = now;
                }

                if(offset < f.size) setTimeout(push, 0);
                else {
                    App.conn.send({type:'file-end', id});
                    App.isSending=false; setTimeout(process, 100);
                }
            };
            push();
        }

        // --- 5. UI æ„å»º (ç¼©ç•¥å›¾ä¸äº¤äº’åˆ†ç¦») ---
        function createFileItem(id, name, size, who, mime) {
            const div = document.createElement('div'); div.className = `msg-row ${who}`; div.id = `msg-${id}`;
            let iconSvg = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>';
            
            // åˆå§‹æ˜¾ç¤ºé€šç”¨å›¾æ ‡
            div.innerHTML = `
                <div class="file-card">
                    <div class="file-inner">
                        <div class="thumb-box">${iconSvg}</div>
                        <div class="file-info">
                            <div class="file-name">${name}</div>
                            <div class="file-meta"><span>${(size/1024).toFixed(1)} KB</span> <span class="speed-tag"></span></div>
                            <div class="progress-bar"><div class="progress-fill"></div></div>
                        </div>
                    </div>
                    <button class="btn-preview">ğŸ‘ï¸</button>
                </div>`;
            document.getElementById('chat-list').append(div);
            document.getElementById('chat-list').scrollTop = 99999;
        }

        function updateProgress(id, cur, tot, speed) {
            const el = document.getElementById(`msg-${id}`);
            if(el) {
                el.querySelector('.progress-fill').style.width = (cur/tot*100)+'%';
                if(speed) el.querySelector('.speed-tag').innerText = speed;
            }
        }

        function finishFile(id, mime) {
            const el = document.getElementById(`msg-${id}`); if(!el) return;
            el.querySelector('.progress-bar').style.display='none';
            el.querySelector('.speed-tag').innerText = 'å®Œæˆ';
            
            const url = URL.createObjectURL(new Blob(Rx.buf, {type: mime})); Rx.buf = [];
            const inner = el.querySelector('.file-inner');
            const thumbBox = el.querySelector('.thumb-box');
            const btnPreview = el.querySelector('.btn-preview');

            // ä¸‹è½½é€»è¾‘ (ç‚¹å‡»å¡ç‰‡ä¸»ä½“)
            inner.onclick = () => { const a=document.createElement('a'); a.href=url; a.download='file'; a.click(); };

            // ç¼©ç•¥å›¾ & é¢„è§ˆé€»è¾‘
            if (mime.includes('image')) {
                thumbBox.innerHTML = `<img src="${url}" class="thumb-img">`;
                btnPreview.style.display = 'flex';
                btnPreview.onclick = (e) => { e.stopPropagation(); openLightbox(url, 'img'); }; // é˜»æ­¢å†’æ³¡ï¼Œåªé¢„è§ˆä¸ä¸‹è½½
            } 
            else if (mime.includes('video')) {
                const video = document.createElement('video');
                video.src = url; video.currentTime = 1; // å°è¯•è·å–ç¬¬1ç§’å¸§
                video.className = 'thumb-img';
                thumbBox.innerHTML = ''; thumbBox.appendChild(video);
                btnPreview.innerHTML = 'â–¶';
                btnPreview.style.display = 'flex';
                btnPreview.onclick = (e) => { e.stopPropagation(); openLightbox(url, 'video'); };
            }
        }

        // --- ç¯ç®±ä¸æ‚é¡¹ ---
        function openLightbox(url, type) {
            const lb=document.getElementById('lightbox'), img=document.getElementById('lb-img'), vid=document.getElementById('lb-video');
            img.style.display='none'; vid.style.display='none'; lb.classList.add('active');
            if(type==='img') { img.src=url; img.style.display='block'; }
            else { vid.src=url; vid.style.display='block'; vid.play(); }
        }
        window.closeLightbox = () => { document.getElementById('lightbox').classList.remove('active'); document.getElementById('lb-video').pause(); };

        // è¯­éŸ³é€»è¾‘ç•¥ (ä¿æŒ V10 ä¸å˜)
        const bVoice=document.getElementById('btn-voice');
        let mRec, chunks=[];
        bVoice.onmousedown = bVoice.ontouchstart = async (e) => {
            e.preventDefault(); if(!App.connected) return;
            const s = await navigator.mediaDevices.getUserMedia({audio:true});
            mRec = new MediaRecorder(s); chunks=[];
            mRec.ondataavailable = e => chunks.push(e.data);
            mRec.onstop = () => enqueue([new File([new Blob(chunks)], "voice.webm", {type:'audio/webm'})]);
            mRec.start(); bVoice.classList.add('recording'); bVoice.innerText="æ¾å¼€ å‘é€";
        }
        bVoice.onmouseup = bVoice.ontouchend = (e) => { e.preventDefault(); if(mRec) mRec.stop(); bVoice.classList.remove('recording'); bVoice.innerText="æŒ‰ä½ è¯´è¯"; }

        // UI åˆ‡æ¢
        window.toggleInput = () => {
            const t=document.getElementById('msg-input'), v=document.getElementById('btn-voice'), s=document.getElementById('btn-send'), p=document.getElementById('btn-plus');
            if(t.style.display==='none'){ t.style.display='block'; v.style.display='none'; s.style.display='block'; p.style.display='none'; t.focus(); } 
            else{ t.style.display='none'; v.style.display='flex'; s.style.display='none'; p.style.display='flex'; }
        }
        window.sendText = () => { const v=document.getElementById('msg-input').value; if(v){ App.conn.send({type:'text',text:v}); addMsg(v,'self'); document.getElementById('msg-input').value=''; } }
        function addMsg(t,w){ const d=document.createElement('div'); d.className=`msg-row ${w}`; d.innerHTML=`<div class="bubble">${t}</div>`; document.getElementById('chat-list').append(d); document.getElementById('chat-list').scrollTop=99999; }
        
        let qr; window.toggleScan=()=>{ const s=document.getElementById('scanner-box'); if(s.style.display==='block'){s.style.display='none';if(qr)qr.stop();}else{s.style.display='block';qr=new Html5Qrcode("reader");qr.start({facingMode:"environment"},{fps:10},t=>{document.getElementById('target-id').value=t;toggleScan();});}};
    </script>
</body>
</html>
