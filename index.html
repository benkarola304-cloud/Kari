<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4A90E2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>æ ‘æ‡’å¿«ä¼  V5</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2353/2353678.png">
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        :root {
            --primary: #4A90E2; 
            --bg: #F5F7FA;
            --chat-bg: #EBF1F5;
            --self-bubble: #4A90E2;
            --peer-bubble: #FFFFFF;
            --text-dark: #2C3E50;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; font-family: -apple-system, "PingFang SC", sans-serif; 
            background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
            color: var(--text-dark);
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar {
            height: 56px; padding: 0 15px; background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center; z-index: 20;
        }
        .brand { font-size: 16px; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .sloth-icon { width: 32px; height: 32px; animation: breathe 3s infinite ease-in-out; }
        @keyframes breathe { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }

        .status-badge { font-size: 11px; padding: 4px 10px; border-radius: 20px; background: #eee; color: #777; font-weight: 600; }
        .status-badge.online { background: #D1F2EB; color: #117A65; }

        /* ä¸»å†…å®¹åŒº */
        .main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }

        /* 1. å›ºå®šä¼ è¾“æŠ•é€’åŒº (æ–°éœ€æ±‚) */
        .drop-panel {
            margin: 15px 15px 0 15px;
            height: 100px; /* å›ºå®šé«˜åº¦ */
            background: white; border: 2px dashed #CBD5E0; border-radius: 16px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--primary); cursor: pointer; transition: 0.2s; flex-shrink: 0;
        }
        .drop-panel:active, .drop-panel.drag-over { background: #EBF8FF; border-color: var(--primary); transform: scale(0.99); }
        .drop-icon { font-size: 32px; margin-bottom: 5px; }
        .drop-text { font-size: 13px; font-weight: 600; color: #718096; }

        /* 2. èŠå¤©/æ—¥å¿—åŒº */
        .chat-scroll {
            flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;
        }

        .message { max-width: 85%; display: flex; flex-direction: column; }
        .message.self { align-self: flex-end; align-items: flex-end; }
        .message.peer { align-self: flex-start; align-items: flex-start; }
        
        .bubble {
            padding: 10px 14px; border-radius: 16px; font-size: 14px; line-height: 1.4;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); max-width: 100%; word-break: break-all;
        }
        .message.self .bubble { background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .message.peer .bubble { background: white; color: #333; border-bottom-left-radius: 2px; }

        /* æ–‡ä»¶æ°”æ³¡ */
        .file-bubble { width: 220px; }
        .file-row { display: flex; align-items: center; gap: 10px; }
        .f-icon { font-size: 24px; }
        .f-name { font-size: 13px; font-weight: 600; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; flex:1; }
        .f-prog { height: 4px; background: rgba(0,0,0,0.1); margin-top: 8px; border-radius: 2px; overflow: hidden; }
        .f-fill { height: 100%; width: 0%; background: rgba(255,255,255,0.8); transition: width 0.2s; }
        .peer .f-fill { background: var(--primary); }
        .speed-txt { font-size: 10px; opacity: 0.8; margin-top: 4px; text-align: right; }

        /* è¯­éŸ³æ°”æ³¡ */
        .voice-bubble { display: flex; align-items: center; gap: 8px; min-width: 100px; cursor: pointer; }
        
        /* åº•éƒ¨è¾“å…¥æ  (å«è¯­éŸ³) */
        .input-bar {
            padding: 10px 15px; background: white; border-top: 1px solid #eee;
            display: flex; gap: 10px; align-items: center; padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        .btn-icon { font-size: 22px; color: #718096; background: none; border: none; padding: 5px; cursor: pointer; }
        
        /* è¯­éŸ³æŒ‰é’® */
        .btn-voice { 
            flex: 1; height: 40px; border-radius: 20px; border: none; font-weight: bold; font-size: 14px;
            background: #F0F2F5; color: #333; touch-action: none; user-select: none;
        }
        .btn-voice.recording { background: #E74C3C; color: white; animation: pulse 1s infinite; }
        @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(231,76,60,0.4)} 70%{box-shadow:0 0 0 10px rgba(231,76,60,0)} 100%{box-shadow:0 0 0 0 rgba(231,76,60,0)} }

        /* æ–‡æœ¬è¾“å…¥æ¡† (é»˜è®¤éšè—ï¼Œåˆ‡æ¢æ˜¾ç¤º) */
        #msg-input { flex: 1; height: 40px; padding: 0 15px; border-radius: 20px; background: #F0F2F5; border: none; outline: none; display: none; }
        
        /* è¿æ¥å¼¹çª— */
        .modal {
            position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .card { width: 85%; max-width: 360px; text-align: center; }
        .scan-view { width: 100%; height: 250px; background: black; margin: 15px 0; border-radius: 12px; overflow: hidden; display: none; }
        .big-btn { 
            width: 100%; padding: 14px; border-radius: 12px; border: none; 
            background: var(--primary); color: white; font-weight: bold; font-size: 16px; margin-top: 10px; 
            box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3);
        }

    </style>
</head>
<body>

    <div class="modal" id="modal">
        <div class="card">
            <img src="https://cdn-icons-png.flaticon.com/512/2353/2353678.png" width="100" style="margin-bottom:20px">
            <h2 style="margin:0 0 10px 0;">æ ‘æ‡’å¿«ä¼  V5</h2>
            <div id="qr-code" style="margin:20px auto; padding:10px; background:white; border:1px solid #eee; display:inline-block; border-radius:10px;"></div>
            <div id="my-id" style="font-family:monospace; font-weight:bold; font-size:18px; color:#555; margin-bottom:20px;">ID ç”Ÿæˆä¸­...</div>
            
            <input id="target-id" type="text" placeholder="è¾“å…¥å¯¹æ–¹ ID" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ddd; text-align:center; font-size:16px;">
            <div id="scanner" class="scan-view"><div id="reader" style="width:100%;height:100%"></div></div>
            
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="big-btn" onclick="toggleScan()" style="background:#34495E; flex:1">ğŸ“· æ‰«ç </button>
                <button class="big-btn" onclick="connect()" style="flex:2">è¿æ¥ âš¡ï¸</button>
            </div>
        </div>
    </div>

    <div class="navbar">
        <div class="brand">
            <img src="https://cdn-icons-png.flaticon.com/512/2353/2353678.png" class="sloth-icon">
            <span>æ ‘æ‡’å¿«ä¼ </span>
        </div>
        <div class="status-badge" id="status">ç¦»çº¿</div>
    </div>

    <div class="main-container">
        <div class="drop-panel" id="drop-zone">
            <div class="drop-icon">ğŸ“‚</div>
            <div class="drop-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶/æ–‡ä»¶å¤¹åˆ°è¿™é‡Œ</div>
        </div>

        <div class="chat-scroll" id="chat-list">
            <div style="text-align:center; color:#aaa; font-size:12px; margin-top:20px;">
                å·²å¯ç”¨å±å¹•å¸¸äº®ä¿æ´»<br>æ”¯æŒæ‹–æ‹½å¤šä¸ªå›¾ç‰‡ã€æ–‡ä»¶å¤¹
            </div>
        </div>
    </div>

    <div class="input-bar">
        <button class="btn-icon" onclick="toggleInputMode()">âŒ¨ï¸</button>
        
        <button id="btn-voice" class="btn-voice">æŒ‰ä½ è¯´è¯</button>
        <input id="msg-input" type="text" placeholder="è¾“å…¥æ–‡å­—..." autocomplete="off">
        
        <button class="btn-icon" id="btn-send" style="color:var(--primary); display:none;" onclick="sendText()">â¤</button>
    </div>

    <input type="file" id="file-input" multiple style="display:none">

    <script>
        // --- ç³»ç»ŸçŠ¶æ€ ---
        const App = {
            id: null,
            peer: null,
            conn: null,
            connected: false,
            queue: [],
            isSending: false,
            wakeLock: null
        };
        
        // --- 1. æ¯å±ä¿æ´» (Wake Lock) ---
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    App.wakeLock = await navigator.wakeLock.request('screen');
                    console.log('å±å¹•å¸¸äº®å·²æ¿€æ´»');
                } catch (err) { console.log('WakeLock Error:', err); }
            }
        }
        document.addEventListener('visibilitychange', async () => {
            if (App.wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock(); // åˆ‡å›æ¥æ—¶é‡æ–°ç”³è¯·
            }
        });

        // --- 2. åˆå§‹åŒ– ---
        function init() {
            App.id = localStorage.getItem('sloth_id_v5') || (Math.floor(Math.random()*9000)+1000).toString();
            localStorage.setItem('sloth_id_v5', App.id);
            document.getElementById('my-id').innerText = App.id;
            
            new QRCode(document.getElementById("qr-code"), { text: App.id, width: 100, height: 100 });
            
            App.peer = new Peer(App.id, { debug: 1 });
            App.peer.on('open', () => { 
                document.getElementById('status').innerText = 'ç­‰å¾…è¿æ¥'; 
                requestWakeLock();
            });
            App.peer.on('connection', conn => {
                if(confirm('æ¥å—è¿æ¥ï¼ŸID: ' + conn.peer)) setupConn(conn);
            });
            App.peer.on('error', err => alert('ç½‘ç»œé”™è¯¯: ' + err.type));
        }

        function connect() {
            const tid = document.getElementById('target-id').value.trim();
            if(!tid) return;
            setupConn(App.peer.connect(tid, { reliable: true }));
        }

        function setupConn(conn) {
            if(App.conn) App.conn.close();
            App.conn = conn;
            conn.on('open', () => conn.send({ type: 'handshake' }));
            conn.on('data', data => handleData(data));
            conn.on('close', () => location.reload());
        }

        function setConnected() {
            App.connected = true;
            document.getElementById('modal').style.display = 'none';
            document.getElementById('status').innerText = 'åœ¨çº¿';
            document.getElementById('status').classList.add('online');
            requestWakeLock();
        }

        // --- 3. æ ¸å¿ƒæ•°æ®å¤„ç† ---
        let Rx = { buf: [], size: 0, meta: null, last: 0 };

        function handleData(data) {
            // A. ä¿¡ä»¤
            if (data.type) {
                if(data.type === 'handshake') {
                    if(!App.connected) App.conn.send({ type: 'handshake' });
                    setConnected();
                }
                else if(data.type === 'text') addMsg(data.text, 'peer');
                else if(data.type === 'file-start') {
                    Rx = { buf: [], size: 0, meta: data, last: Date.now() };
                    createFileItem(data.id, data.name, data.size, 'peer', data.mime);
                }
                else if(data.type === 'file-end') {
                    finishFile(data.id, Rx.meta.mime);
                }
            }
            // B. äºŒè¿›åˆ¶æµ
            else if (data instanceof Uint8Array || data instanceof ArrayBuffer) {
                Rx.buf.push(data);
                Rx.size += data.byteLength;
                updateProgress(Rx.meta.id, Rx.size, Rx.meta.size);
            }
        }

        // --- 4. ä¿®å¤åçš„æ‹–æ‹½é€»è¾‘ (æ”¯æŒå¤šå›¾ç‰‡/æ–‡ä»¶å¤¹) ---
        const dropZone = document.getElementById('drop-zone');
        dropZone.onclick = () => document.getElementById('file-input').click();
        
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); };
        dropZone.ondragleave = () => dropZone.classList.remove('drag-over');
        
        dropZone.ondrop = async (e) => {
            e.preventDefault(); 
            dropZone.classList.remove('drag-over');
            
            // å…³é”®ä¿®å¤ï¼šéå†æ‰€æœ‰ items
            const items = [...e.dataTransfer.items];
            let filesToSend = [];

            for (let item of items) {
                const entry = item.webkitGetAsEntry ? item.webkitGetAsEntry() : null;
                if (entry) {
                    filesToSend = filesToSend.concat(await scanEntry(entry));
                } else if (item.kind === 'file') {
                    filesToSend.push(item.getAsFile());
                }
            }
            if(filesToSend.length) enqueue(filesToSend);
        };

        // é€’å½’æ‰«æå™¨
        async function scanEntry(entry) {
            if (entry.isFile) return new Promise(r => entry.file(f => r([f])));
            if (entry.isDirectory) {
                const reader = entry.createReader();
                const entries = await new Promise(r => reader.readEntries(r));
                let res = [];
                for(let e of entries) res = res.concat(await scanEntry(e));
                return res;
            }
            return [];
        }

        document.getElementById('file-input').onchange = (e) => enqueue(e.target.files);

        // --- 5. å‘é€é˜Ÿåˆ— ---
        function enqueue(files) {
            if(!App.connected) return alert('è¯·å…ˆè¿æ¥');
            Array.from(files).forEach(f => {
                const id = 'f-'+Date.now()+Math.random().toString(16).substr(2,4);
                createFileItem(id, f.name, f.size, 'self', f.type);
                App.queue.push({ f, id });
            });
            processQueue();
        }

        function processQueue() {
            if(App.isSending || !App.queue.length) return;
            App.isSending = true;
            const job = App.queue.shift();
            sendFile(job);
        }

        function sendFile({ f, id }) {
            App.conn.send({ type:'file-start', id, name:f.name, size:f.size, mime:f.type });
            const reader = new FileReader();
            let offset = 0;
            
            const push = () => {
                if(App.conn.dataChannel.bufferedAmount > 65536) { setTimeout(push, 20); return; }
                const slice = f.slice(offset, offset + 32768);
                reader.readAsArrayBuffer(slice);
            };

            reader.onload = e => {
                App.conn.send(e.target.result);
                offset += e.target.result.byteLength;
                updateProgress(id, offset, f.size);
                if(offset < f.size) setTimeout(push, 0);
                else {
                    App.conn.send({ type:'file-end', id });
                    finishSent(id);
                    App.isSending = false;
                    setTimeout(processQueue, 100);
                }
            };
            push();
        }

        // --- 6. è¯­éŸ³åŠŸèƒ½ (MediaRecorder) ---
        let mediaRecorder;
        let audioChunks = [];
        const btnVoice = document.getElementById('btn-voice');

        // è§¦æ‘¸/é¼ æ ‡æŒ‰ä¸‹å¼€å§‹
        const startRec = async (e) => {
            e.preventDefault();
            if(!App.connected) return alert('è¯·å…ˆè¿æ¥');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = sendVoice;
                mediaRecorder.start();
                btnVoice.classList.add('recording');
                btnVoice.innerText = "æ¾å¼€ å‘é€";
            } catch(err) {
                alert("æ— æ³•è®¿é—®éº¦å…‹é£(éœ€HTTPSæˆ–æœ¬åœ°ç¯å¢ƒ): " + err.message);
            }
        };

        // æ¾å¼€ç»“æŸ
        const stopRec = (e) => {
            e.preventDefault();
            if(mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                btnVoice.classList.remove('recording');
                btnVoice.innerText = "æŒ‰ä½ è¯´è¯";
            }
        };

        btnVoice.addEventListener('touchstart', startRec);
        btnVoice.addEventListener('touchend', stopRec);
        btnVoice.addEventListener('mousedown', startRec);
        btnVoice.addEventListener('mouseup', stopRec);

        function sendVoice() {
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            // å°è£…æˆæ–‡ä»¶å‘é€
            const file = new File([blob], "voice-msg.webm", { type: "audio/webm" });
            enqueue([file]);
        }

        // --- 7. UI æ¸²æŸ“ ---
        function toggleInputMode() {
            const vBtn = document.getElementById('btn-voice');
            const tInput = document.getElementById('msg-input');
            const sBtn = document.getElementById('btn-send');
            if(tInput.style.display === 'none') {
                vBtn.style.display = 'none';
                tInput.style.display = 'block';
                sBtn.style.display = 'block';
                tInput.focus();
            } else {
                vBtn.style.display = 'block';
                tInput.style.display = 'none';
                sBtn.style.display = 'none';
            }
        }

        function sendText() {
            const val = document.getElementById('msg-input').value;
            if(val) {
                App.conn.send({ type: 'text', text: val });
                addMsg(val, 'self');
                document.getElementById('msg-input').value = '';
            }
        }

        function addMsg(txt, type) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerHTML = `<div class="bubble">${txt}</div>`;
            document.getElementById('chat-list').appendChild(div);
            scrollBottom();
        }

        function createFileItem(id, name, size, type, mime) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.id = `msg-${id}`;
            const isVoice = mime.includes('audio');
            const icon = isVoice ? 'ğŸ¤' : (type==='self'?'ğŸ“¤':'ğŸ“¥');
            const displaySize = (size/1024).toFixed(0) + 'KB';
            
            div.innerHTML = `
                <div class="bubble file-bubble">
                    <div class="file-row">
                        <div class="f-icon">${icon}</div>
                        <div class="f-name">${isVoice ? 'è¯­éŸ³æ¶ˆæ¯' : name}</div>
                        <div style="font-size:11px">${displaySize}</div>
                    </div>
                    <div class="f-prog"><div class="f-fill" style="width:0%"></div></div>
                    <div class="speed-txt">ç­‰å¾…ä¼ è¾“...</div>
                    <div class="media-box" style="margin-top:5px; display:none"></div>
                </div>`;
            document.getElementById('chat-list').appendChild(div);
            scrollBottom();
        }

        function updateProgress(id, now, total) {
            const el = document.getElementById(`msg-${id}`);
            if(el) {
                el.querySelector('.f-fill').style.width = (now/total*100)+'%';
                el.querySelector('.speed-txt').innerText = ((now/total)*100).toFixed(0)+'%';
            }
        }

        function finishFile(id, mime) {
            const el = document.getElementById(`msg-${id}`);
            if(!el) return;
            const blob = new Blob(Rx.buf, {type:mime});
            const url = URL.createObjectURL(blob);
            Rx.buf = [];
            
            el.querySelector('.f-prog').style.display='none';
            el.querySelector('.speed-txt').style.display='none';
            const box = el.querySelector('.media-box');
            box.style.display = 'block';

            if(mime.includes('image')) {
                box.innerHTML = `<img src="${url}" style="width:100%; border-radius:8px">`;
            } else if(mime.includes('audio')) {
                box.innerHTML = `<audio controls src="${url}" style="width:100%; height:30px;"></audio>`;
            } else {
                box.innerHTML = `<a href="${url}" download="file" style="color:blue; text-decoration:underline">ä¸‹è½½æ–‡ä»¶</a>`;
            }
            scrollBottom();
        }
        
        function finishSent(id) {
            const el = document.getElementById(`msg-${id}`);
            if(el) el.querySelector('.speed-txt').innerText = 'âœ… å·²å‘é€';
        }

        function scrollBottom() { const c = document.getElementById('chat-list'); c.scrollTop = c.scrollHeight; }

        // æ‰«ç é€»è¾‘
        let html5QrCode;
        window.toggleScan = () => {
            const s = document.getElementById('scanner');
            if(s.style.display === 'block') { s.style.display = 'none'; if(html5QrCode) html5QrCode.stop(); }
            else {
                s.style.display = 'block';
                html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start({ facingMode: "environment" }, {fps:10, qrbox:250}, txt=>{
                    document.getElementById('target-id').value = txt; toggleScan();
                });
            }
        };

        init();
        if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>
