<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FFF8E7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>é—ªç”µå¿«ä¼ </title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="./sloth.png">
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        :root {
            --primary: #2D7CA8; --primary-light: #EBF5FF; --accent: #FF8F66;
            --bg: #FFF8E7; --surface: #FFFFFF;
            --text-main: #3E3228; --text-sub: #8D8176;
            --radius-L: 24px; --radius-M: 16px;
            --shadow-float: 0 12px 30px rgba(62, 50, 40, 0.08);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* ä¿®å¤ï¼šAndroid å¸ƒå±€æº¢å‡ºï¼Œä½¿ç”¨ dvh */
        body { 
            margin: 0; font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif; 
            background: var(--bg); 
            height: 100dvh; /* å…³é”®ï¼šåŠ¨æ€é«˜åº¦ */
            width: 100vw;
            display: flex; flex-direction: column; overflow: hidden; 
            color: var(--text-main);
        }

        .icon { width: 24px; height: 24px; fill: currentColor; }
        .icon-lg { width: 32px; height: 32px; }

        /* å¯¼èˆªæ  */
        .navbar {
            height: 60px; padding: 0 16px; 
            background: rgba(255, 248, 231, 0.9); backdrop-filter: blur(10px);
            display: flex; justify-content: space-between; align-items: center; 
            z-index: 50; flex-shrink: 0; border-bottom: 1px solid rgba(0,0,0,0.03);
        }
        .brand { display: flex; align-items: center; gap: 10px; }
        
        /* ä¿®å¤ï¼šå¤´åƒæ··åˆæ¨¡å¼ (è‡ªåŠ¨å»ç™½åº•) */
        .app-logo { 
            width: 38px; height: 38px; border-radius: 50%; 
            object-fit: cover; 
            mix-blend-mode: multiply; /* é»‘ç§‘æŠ€ï¼šè®©ç™½åº•å˜é€æ˜ */
        }
        .app-name { font-size: 17px; font-weight: 800; color: var(--text-main); }
        .status-pill { font-size: 11px; padding: 5px 12px; border-radius: 20px; background: rgba(0,0,0,0.05); color: var(--text-sub); font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .status-pill.online { background: #D1F2EB; color: #0E6251; }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

        /* ä¸»ç•Œé¢ */
        .main-container { 
            flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; 
            padding-bottom: 70px; /* ç•™å‡ºåº•éƒ¨æ é«˜åº¦ï¼Œé˜²æ­¢é®æŒ¡ */
        }
        
        /* å…¨å±€æ‹–æ‹½é®ç½© (ä¿®å¤æ‹–æ‹½æ— æ•ˆ) */
        .drag-overlay {
            position: absolute; inset: 10px; border: 3px dashed var(--primary); border-radius: var(--radius-L);
            background: rgba(255,255,255,0.9); z-index: 999; backdrop-filter: blur(4px);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            color: var(--primary); font-weight: bold; pointer-events: none; /* è®©äº‹ä»¶ç©¿é€ */
        }
        .drag-overlay.active { display: flex; }

        .chat-scroll { 
            flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; 
            scroll-behavior: smooth; -webkit-overflow-scrolling: touch;
        }
        .sys-notice { text-align: center; font-size: 12px; color: var(--text-sub); opacity: 0.6; margin: 10px 0; }

        /* æ¶ˆæ¯æ ·å¼ */
        .msg-row { display: flex; width: 100%; margin-bottom: 2px; }
        .msg-row.self { justify-content: flex-end; } .msg-row.peer { justify-content: flex-start; }
        .bubble { max-width: 85%; padding: 10px 14px; border-radius: var(--radius-M); font-size: 15px; line-height: 1.4; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .msg-row.self .bubble { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .msg-row.peer .bubble { background: var(--surface); color: var(--text-main); border-bottom-left-radius: 4px; }

        /* æ–‡ä»¶å¡ç‰‡ (ä¿®å¤ï¼šæ–‡å­—çœ‹ä¸æ¸…) */
        .file-card { width: 240px; padding: 0; background: transparent; box-shadow: none; }
        .file-inner { 
            background: var(--surface); border-radius: 12px; padding: 10px; 
            display: flex; align-items: center; gap: 10px; position: relative;
        }
        /* å‘é€æ–¹æ–‡ä»¶å¡ç‰‡ï¼šæ·±è‰²åŠé€æ˜èƒŒæ™¯ï¼Œç¡®ä¿ç™½å­—æ¸…æ™° */
        .msg-row.self .file-inner { 
            background: rgba(0, 0, 0, 0.2); /* å…³é”®ä¿®å¤ï¼šåŠ æ·±èƒŒæ™¯ */
            border: 1px solid rgba(255,255,255,0.1); 
        }
        
        .file-icon-box { 
            width: 40px; height: 40px; border-radius: 10px; background: #F3F4F6; color: var(--text-sub); 
            display: flex; align-items: center; justify-content: center; flex-shrink: 0; 
        }
        .msg-row.self .file-icon-box { background: rgba(255,255,255,0.25); color: white; }

        .file-info { flex: 1; overflow: hidden; }
        .file-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-meta { font-size: 11px; opacity: 0.8; margin-top: 2px; }
        /* å¼ºåˆ¶å‘é€æ–¹æ–‡å­—ä¸ºç™½è‰² */
        .msg-row.self .file-name, .msg-row.self .file-meta { color: #FFFFFF; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        .progress-bar { height: 3px; background: rgba(0,0,0,0.05); margin-top: 6px; border-radius: 2px; overflow: hidden; width: 100%; }
        .progress-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.2s; }
        .msg-row.self .progress-bar { background: rgba(255,255,255,0.3); }
        .msg-row.self .progress-fill { background: white; }

        .action-btn { 
            position: absolute; right: 10px; top: 10px; bottom: 10px; 
            background: var(--primary); color: white; border: none; padding: 0 12px; 
            border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; 
            display: none; align-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        /* ä¿®å¤ï¼šåº•éƒ¨æ å›ºå®š (Android è·‘å‡ºå±å¹•é—®é¢˜) */
        .input-area-wrapper {
            position: fixed; bottom: 0; left: 0; right: 0; /* å¼ºåˆ¶å›ºå®šåº•éƒ¨ */
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            padding: 8px 12px;
            padding-bottom: max(8px, var(--safe-bottom));
            box-shadow: 0 -2px 10px rgba(0,0,0,0.02);
            z-index: 100;
        }
        .input-bar { display: flex; align-items: center; gap: 8px; height: 44px; }
        
        .btn-circle {
            width: 40px; height: 40px; border-radius: 50%; border: none; background: #F2F0EB; color: var(--text-sub); 
            display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
        }
        .btn-circle.primary { background: var(--primary); color: white; }
        
        .btn-voice-long { 
            flex: 1; height: 40px; border-radius: 20px; border: none; background: #F2F0EB; 
            color: var(--text-main); font-weight: 700; font-size: 14px;
            display: flex; align-items: center; justify-content: center; gap: 6px; user-select: none; 
        }
        .btn-voice-long.recording { background: var(--accent); color: white; animation: pulse 1s infinite; }
        
        #msg-input { 
            flex: 1; height: 40px; padding: 0 16px; border-radius: 20px; background: #F2F0EB; 
            border: 1px solid transparent; outline: none; font-size: 15px; display: none; min-width: 0; 
        }
        #msg-input:focus { background: white; border-color: var(--primary); }

        /* å¼¹çª— */
        .modal { position: fixed; inset: 0; background: rgba(255,248,231,0.96); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card { width: 85%; max-width: 340px; background: white; padding: 30px 20px; border-radius: 28px; text-align: center; box-shadow: var(--shadow-float); }
        
        /* ä¿®å¤ï¼šå¤´åƒåŠ¨ç”»ä¸å»ç™½åº• */
        .hero-img { 
            width: 90px; height: 90px; margin-bottom: 15px; object-fit: contain; 
            mix-blend-mode: multiply; /* å»ç™½åº•é»‘ç§‘æŠ€ */
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }

        .id-display { background: #F5F7FA; padding: 10px; border-radius: 10px; margin: 15px 0; font-family: monospace; font-weight: bold; font-size: 18px; color: var(--text-main); letter-spacing: 1px;}
        .input-id { width: 100%; height: 46px; border-radius: 14px; border: 2px solid #EEE; text-align: center; font-size: 16px; background: #FAFAFA; margin-bottom: 15px; outline: none;}
        .input-id:focus { border-color: var(--primary); background: white; }
        .btn-block { width: 100%; height: 48px; border-radius: 14px; border: none; background: var(--primary); color: white; font-weight: 700; font-size: 15px; cursor: pointer;}
        .btn-ghost { background: #F2F0EB; color: var(--text-main); }
        #scanner-box { border-radius: 16px; overflow: hidden; margin-bottom: 15px; display: none; height: 240px; background: black; }

        /* ç¯ç®± */
        .lightbox { position: fixed; inset: 0; background: black; z-index: 3000; display: none; align-items: center; justify-content: center; }
        .lightbox.active { display: flex; animation: fadeIn 0.2s; }
        .lightbox-content { max-width: 100%; max-height: 100%; object-fit: contain; }
        .btn-close { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.3); width: 36px; height: 36px; border-radius: 50%; border:none; color:white; font-size:24px; z-index: 3001; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }

    </style>
</head>
<body>

    <div class="lightbox" id="lightbox" onclick="closeLightbox()">
        <button class="btn-close">Ã—</button>
        <img id="lb-img" class="lightbox-content" style="display:none" onclick="event.stopPropagation()">
        <video id="lb-video" class="lightbox-content" controls style="display:none" onclick="event.stopPropagation()"></video>
    </div>

    <div class="modal" id="modal">
        <div class="card">
            <img src="./sloth.png" class="hero-img" alt="Logo">
            <h2 style="margin:0; font-size:20px; color:var(--text-main)">é—ªç”µå¿«ä¼ </h2>
            <div id="qr-code" style="margin:20px auto; padding:8px; background:white; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.05); display:inline-block;"></div>
            <div class="id-display" id="my-id">...</div>
            
            <input type="text" id="target-id" class="input-id" placeholder="è¾“å…¥å¯¹æ–¹ ID" autocomplete="off">
            <div id="scanner-box"><div id="reader" style="width:100%;height:100%"></div></div>

            <div style="display:flex; gap:10px;">
                <button class="btn-block btn-ghost" onclick="toggleScan()" style="flex:1">ğŸ“·</button>
                <button class="btn-block" onclick="connect()" style="flex:2">è¿æ¥</button>
            </div>
        </div>
    </div>

    <div class="navbar">
        <div class="brand">
            <img src="./sloth.png" class="app-logo">
            <span class="app-name">é—ªç”µå¿«ä¼ </span>
        </div>
        <div class="status-pill" id="status"><div class="dot"></div><span>ç¦»çº¿</span></div>
    </div>

    <div class="main-container">
        <div class="drag-overlay" id="drag-overlay">
            <svg class="icon-lg" style="width:60px;height:60px;margin-bottom:10px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
            <div style="font-size:18px">æ¾æ‰‹ å‘é€æ–‡ä»¶</div>
        </div>

        <div class="chat-scroll" id="chat-list">
            <div class="sys-notice">V9.0 å®Œç¾é€‚é…ç‰ˆ<br>ä¿®å¤PCæ‹–æ‹½ Â· ä¿®å¤å®‰å“æ˜¾ç¤º Â· ä¿®å¤ç™½å­—ä¸æ¸…</div>
        </div>
    </div>

    <div class="input-area-wrapper">
        <div class="input-bar">
            <button class="btn-circle" onclick="toggleInputMode()">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h2v2H6zm4 0h2v2h-2zm4 0h2v2h-2zm-8 4h2v2H6zm4 0h2v2h-2zm4 0h2v2h-2zm-8 4h12v2H6z"/></svg>
            </button>
            <button id="btn-voice" class="btn-voice-long">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                <span>æŒ‰ä½ è¯´è¯</span>
            </button>
            <input id="msg-input" type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off">
            <button class="btn-circle primary" id="btn-send" style="display:none;" onclick="sendText()">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
            <button class="btn-circle" id="btn-plus" onclick="document.getElementById('file-input').click()">
                 <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            </button>
        </div>
    </div>
    <input type="file" id="file-input" multiple style="display:none">

    <script>
        // --- æ ¸å¿ƒé€»è¾‘ ---
        const App = { id: null, peer: null, conn: null, connected: false, queue: [], isSending: false, wakeLock: null };
        async function reqWake() { if ('wakeLock' in navigator) try { App.wakeLock = await navigator.wakeLock.request('screen'); } catch(e){} }
        document.addEventListener('visibilitychange', async () => { if (App.wakeLock && document.visibilityState==='visible') reqWake(); });

        function init() {
            App.id = localStorage.getItem('sloth_v9') || (Math.floor(Math.random()*9000)+1000).toString();
            localStorage.setItem('sloth_v9', App.id);
            document.getElementById('my-id').innerText = App.id;
            new QRCode(document.getElementById("qr-code"), { text: App.id, width: 90, height: 90, colorDark: "#2D7CA8", colorLight: "#FFFFFF" });
            
            App.peer = new Peer(App.id, { debug: 1 });
            App.peer.on('open', () => { document.querySelector('#status span').innerText='ç­‰å¾…è¿æ¥'; reqWake(); });
            App.peer.on('connection', conn => { if(confirm('è¿æ¥ ID: '+conn.peer+'?')) setupConn(conn); });
            App.peer.on('error', err => alert('Err: '+err.type));
        }
        function connect() { const tid = document.getElementById('target-id').value.trim(); if(tid) setupConn(App.peer.connect(tid, { reliable: true })); }
        function setupConn(conn) {
            if(App.conn) App.conn.close(); App.conn = conn;
            conn.on('open', () => conn.send({ type: 'handshake' }));
            conn.on('data', handleData);
            conn.on('close', () => location.reload());
        }
        function setConnected() {
            App.connected = true; document.getElementById('modal').style.display = 'none';
            const s = document.getElementById('status'); s.classList.add('online'); s.querySelector('span').innerText='å·²è¿æ¥';
            reqWake();
        }

        let Rx = { buf: [], size: 0, meta: null };
        function handleData(data) {
            if (data.type) {
                if(data.type === 'handshake') { if(!App.connected) App.conn.send({type:'handshake'}); setConnected(); }
                else if(data.type === 'text') addMsg(data.text, 'peer');
                else if(data.type === 'file-start') { Rx = { buf: [], size: 0, meta: data }; createFileItem(data.id, data.name, data.size, 'peer', data.mime); }
                else if(data.type === 'file-end') finishFile(data.id, Rx.meta.mime);
            } else { Rx.buf.push(data); Rx.size += data.byteLength; updateProgress(Rx.meta.id, Rx.size, Rx.meta.size); }
        }

        // --- ä¿®å¤ï¼šå…¨å±€æ‹–æ‹½é€»è¾‘ ---
        let dragCounter = 0;
        const dragOverlay = document.getElementById('drag-overlay');
        
        window.addEventListener('dragenter', e => { e.preventDefault(); dragCounter++; dragOverlay.classList.add('active'); });
        window.addEventListener('dragleave', e => { e.preventDefault(); dragCounter--; if(dragCounter === 0) dragOverlay.classList.remove('active'); });
        window.addEventListener('dragover', e => e.preventDefault());
        window.addEventListener('drop', async e => {
            e.preventDefault(); dragCounter = 0; dragOverlay.classList.remove('active');
            const items = [...e.dataTransfer.items], list = [];
            for (let i of items) {
                const ent = i.webkitGetAsEntry ? i.webkitGetAsEntry() : null;
                if (ent) list = list.concat(await scanEntry(ent));
                else if (i.kind === 'file') list.push(i.getAsFile());
            }
            if(list.length) enqueue(list);
        });
        
        async function scanEntry(e){
            if(e.isFile) return new Promise(r=>e.file(f=>r([f])));
            if(e.isDirectory){ const r=e.createReader(); const ents=await new Promise(res=>r.readEntries(res)); let arr=[]; for(let sub of ents) arr=arr.concat(await scanEntry(sub)); return arr; } return [];
        }
        document.getElementById('file-input').onchange=e=>enqueue(e.target.files);

        function enqueue(files) {
            if(!App.connected) return alert('è¯·è¿æ¥');
            Array.from(files).forEach(f => { const id = 'f-'+Date.now()+Math.random().toString(16).substr(2,4); createFileItem(id, f.name, f.size, 'self', f.type); App.queue.push({ f, id }); });
            processQueue();
        }
        function processQueue() { if(App.isSending || !App.queue.length) return; App.isSending = true; sendFile(App.queue.shift()); }
        function sendFile({ f, id }) {
            App.conn.send({ type:'file-start', id, name:f.name, size:f.size, mime:f.type });
            const r = new FileReader(); let off=0;
            const push=()=>{ if(App.conn.dataChannel.bufferedAmount>65536){setTimeout(push,20);return;} const s = f.slice(off, off+32768); r.readAsArrayBuffer(s); };
            r.onload=e=>{
                App.conn.send(e.target.result); off+=e.target.result.byteLength; updateProgress(id, off, f.size);
                if(off<f.size) setTimeout(push,0); else { App.conn.send({type:'file-end', id}); App.isSending=false; setTimeout(processQueue,100); }
            };
            push();
        }

        let mRec, chunks=[]; const bVoice=document.getElementById('btn-voice');
        const startR=async e=>{
            e.preventDefault(); if(!App.connected) return alert('è¯·è¿æ¥');
            try { const s=await navigator.mediaDevices.getUserMedia({audio:true}); mRec=new MediaRecorder(s); chunks=[]; mRec.ondataavailable=e=>chunks.push(e.data); mRec.onstop=()=>{ enqueue([new File([new Blob(chunks,{type:'audio/webm'})],"voice.webm",{type:'audio/webm'})]) }; mRec.start(); bVoice.classList.add('recording'); bVoice.querySelector('span').innerText="æ¾å¼€ å‘é€"; } catch(err){alert("éº¦å…‹é£ä¸å¯ç”¨");}
        };
        const stopR=e=>{ e.preventDefault(); if(mRec&&mRec.state!=='inactive'){mRec.stop(); bVoice.classList.remove('recording'); bVoice.querySelector('span').innerText="æŒ‰ä½ è¯´è¯";} };
        ['touchstart','mousedown'].forEach(k=>bVoice.addEventListener(k,startR));
        ['touchend','mouseup'].forEach(k=>bVoice.addEventListener(k,stopR));

        function openLightbox(url, type) {
            const lb = document.getElementById('lightbox'), img = document.getElementById('lb-img'), vid = document.getElementById('lb-video');
            img.style.display = 'none'; vid.style.display = 'none'; lb.classList.add('active');
            if (type === 'img') { img.src = url; img.style.display = 'block'; } else { vid.src = url; vid.style.display = 'block'; vid.play(); }
        }
        window.closeLightbox = () => { document.getElementById('lightbox').classList.remove('active'); document.getElementById('lb-video').pause(); };

        function createFileItem(id, name, size, who, mime) {
            const div = document.createElement('div'); div.className = `msg-row ${who}`; div.id = `msg-${id}`;
            let iconSvg;
            if (mime.includes('image')) iconSvg = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>';
            else if (mime.includes('video')) iconSvg = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>';
            else iconSvg = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>';
            div.innerHTML = `<div class="file-card"><div class="file-inner"><div class="file-icon-box">${iconSvg}</div><div class="file-info"><div class="file-name">${name}</div><div class="file-meta">${(size/1024).toFixed(1)} KB</div><div class="progress-bar"><div class="progress-fill"></div></div></div><button class="action-btn">æŸ¥çœ‹</button></div></div>`;
            document.getElementById('chat-list').appendChild(div); document.getElementById('chat-list').scrollTop = 99999;
        }

        function updateProgress(id, cur, tot) { const el = document.getElementById(`msg-${id}`); if(el) el.querySelector('.progress-fill').style.width = (cur/tot*100)+'%'; }
        function finishFile(id, mime) {
            const el = document.getElementById(`msg-${id}`); if(!el) return;
            el.querySelector('.progress-bar').style.display = 'none';
            const url = URL.createObjectURL(new Blob(Rx.buf, {type: mime})); Rx.buf = [];
            const inner = el.querySelector('.file-inner'), btn = el.querySelector('.action-btn');
            btn.style.display = 'flex';
            if (mime.includes('image')) { btn.innerText = "é¢„è§ˆ"; inner.onclick = () => openLightbox(url, 'img'); } 
            else if (mime
