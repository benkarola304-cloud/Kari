<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FFF8E7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Èó™ÁîµÂø´‰º†</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="./sloth.png">
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        :root {
            --primary: #2D7CA8; --bg: #FFF8E7; --surface: #FFFFFF;
            --text-main: #3E3228; --text-sub: #8D8176;
            --radius-L: 24px; --radius-M: 16px;
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; color: var(--text-main); }
        .icon { width: 24px; height: 24px; fill: currentColor; }
        
        /* ÂØºËà™Ê†è */
        .navbar {
            height: 60px; padding: 0 16px; background: rgba(255, 248, 231, 0.95);
            display: flex; justify-content: space-between; align-items: center; z-index: 50; flex-shrink: 0; border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .brand { display: flex; align-items: center; gap: 10px; }
        .logo-box { width: 38px; height: 38px; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .app-logo { width: 100%; height: 100%; object-fit: cover; }
        .app-name { font-size: 17px; font-weight: 800; }
        .status-pill { font-size: 11px; padding: 5px 12px; border-radius: 20px; background: rgba(0,0,0,0.05); color: var(--text-sub); font-weight: 600; }
        .status-pill.online { background: #D1F2EB; color: #0E6251; }

        /* ‰∏ªÁïåÈù¢ */
        .main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; padding-bottom: 70px; }
        
        .drop-zone-wrapper { padding: 16px 20px 0 20px; flex-shrink: 0; transition: 0.2s; }
        .drop-card {
            height: 100px; background: var(--surface); border-radius: var(--radius-L); 
            border: 2px dashed #E0D6CC; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; cursor: pointer; color: var(--primary); 
            box-shadow: 0 4px 12px rgba(62, 50, 40, 0.04); transition: all 0.2s ease;
        }
        .drop-card.drag-active { border: 2px solid var(--primary); background: #EBF5FF; transform: scale(1.02); }
        .drop-label { font-size: 14px; font-weight: 600; color: var(--text-sub); margin-top: 8px; }

        .chat-scroll { flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .sys-notice { text-align: center; font-size: 12px; color: var(--text-sub); opacity: 0.6; margin: 10px 0; }

        /* Ê∂àÊÅØÊ∞îÊ≥° */
        .msg-row { display: flex; width: 100%; margin-bottom: 4px; }
        .msg-row.self { justify-content: flex-end; } .msg-row.peer { justify-content: flex-start; }
        .bubble { max-width: 85%; padding: 10px 14px; border-radius: var(--radius-M); font-size: 15px; background: var(--surface); box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .msg-row.self .bubble { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .msg-row.peer .bubble { border-bottom-left-radius: 4px; }

        /* Êñá‰ª∂Âç°Áâá */
        .file-card { width: 240px; position: relative; }
        .file-inner { background: var(--surface); border-radius: 12px; padding: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .msg-row.self .file-inner { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); }
        
        .thumb-box { width: 48px; height: 48px; border-radius: 8px; background: #F3F4F6; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; }
        .thumb-img { width: 100%; height: 100%; object-fit: cover; }
        .msg-row.self .thumb-box { background: rgba(255,255,255,0.2); color: white; }

        .file-info { flex: 1; overflow: hidden; }
        .file-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-meta { font-size: 11px; opacity: 0.8; margin-top: 2px; display: flex; justify-content: space-between; }
        .msg-row.self .file-name, .msg-row.self .file-meta { color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        .progress-bar { height: 3px; background: rgba(0,0,0,0.05); margin-top: 6px; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.2s; }
        .msg-row.self .progress-fill { background: white; }

        .btn-preview { width: 32px; height: 32px; border-radius: 50%; background: var(--primary); color: white; border: none; position: absolute; right: -10px; bottom: -10px; display: none; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2); cursor: pointer; z-index: 10; }

        /* Â∫ïÈÉ®Ê†è */
        .input-area-wrapper { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.98); padding: 8px 12px; padding-bottom: max(8px, var(--safe-bottom)); z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.02); }
        .input-bar { display: flex; align-items: center; gap: 8px; height: 44px; }
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; border: none; background: #F2F0EB; color: var(--text-sub); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .btn-voice { flex: 1; height: 40px; border-radius: 20px; background: #F2F0EB; border: none; font-weight: bold; color: var(--text-main); }
        .btn-voice.recording { background: #FF8F66; color: white; }
        #msg-input { flex: 1; height: 40px; border-radius: 20px; background: #F2F0EB; border: none; padding: 0 16px; display: none; }

        /* ÂºπÁ™ó & Âä†ËΩΩÂä®Áîª */
        .modal { position: fixed; inset: 0; background: #FFF8E7; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card { width: 85%; max-width: 340px; background: white; padding: 30px 20px; border-radius: 28px; text-align: center; box-shadow: 0 12px 30px rgba(62,50,40,0.08); }
        
        .hero-crop {
            width: 110px; height: 110px; margin: 0 auto 16px auto;
            border-radius: 50%; background: transparent; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.1); overflow: hidden; 
            animation: breathe 3s ease-in-out infinite;
        }
        .hero-img { width: 100%; height: 100%; object-fit: cover; }
        @keyframes breathe { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }

        .id-display { background: #F5F7FA; padding: 10px; border-radius: 10px; margin: 15px 0; font-family: monospace; font-weight: bold; font-size: 18px; }
        .input-id { width: 100%; height: 46px; border-radius: 14px; border: 2px solid #EEE; text-align: center; font-size: 16px; margin-bottom: 15px; outline: none;}
        .btn-block { width: 100%; height: 48px; border-radius: 14px; background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        
        /* ÁÅØÁÆ± */
        .lightbox { position: fixed; inset: 0; background: black; z-index: 3000; display: none; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .lightbox.active { opacity: 1; pointer-events: auto; }
        .lightbox-content { max-width: 100%; max-height: 100%; }
        .btn-close { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.3); width: 36px; height: 36px; border-radius: 50%; border:none; color:white; font-size:24px; z-index: 3001; }

        /* Toast */
        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px;
            border-radius: 20px; font-size: 14px; z-index: 5000;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        #toast.show { opacity: 1; }
        #toast.error { background: #E74C3C; }

    </style>
</head>
<body>

    <div id="toast"></div>

    <div class="lightbox" id="lightbox">
        <button class="btn-close" onclick="triggerClose()">√ó</button>
        <img id="lb-img" class="lightbox-content" style="display:none" onclick="event.stopPropagation()">
        <video id="lb-video" class="lightbox-content" controls style="display:none" onclick="event.stopPropagation()"></video>
    </div>

    <div class="modal" id="modal">
        <div class="card">
            <div class="hero-crop"><img src="./sloth.png" class="hero-img" alt="Logo"></div>
            <h2 style="margin:0; font-size:20px;">Èó™ÁîµÂø´‰º†</h2>
            <div id="qr-code" style="margin:20px auto; padding:8px; background:white; border-radius:12px; display:inline-block; min-height:100px;"></div>
            <div class="id-display" id="my-id">...</div>
            <input type="text" id="target-id" class="input-id" placeholder="ËæìÂÖ•ÂØπÊñπ ID">
            <div id="scanner-box" style="display:none; height:240px; background:black; border-radius:16px; margin-bottom:15px;"><div id="reader" style="width:100%;height:100%"></div></div>
            <div style="display:flex; gap:10px;">
                <button class="btn-block" onclick="toggleScan()" style="flex:1; background:#F2F0EB; color:#333">üì∑</button>
                <button class="btn-block" onclick="connect()" style="flex:2">ËøûÊé•</button>
            </div>
        </div>
    </div>

    <div class="navbar">
        <div class="brand">
            <div class="logo-box"><img src="./sloth.png" class="app-logo"></div>
            <span class="app-name">Èó™ÁîµÂø´‰º†</span>
        </div>
        <div class="status-pill" id="status">Á¶ªÁ∫ø</div>
    </div>

    <div class="main-container">
        <div class="drop-zone-wrapper">
            <div class="drop-card" id="drop-zone">
                <svg class="icon-lg" style="width:32px;height:32px;margin-bottom:5px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                <span class="drop-label">ÁÇπÂáªÊàñÊãñÊãΩÊñá‰ª∂ (Êñá‰ª∂Â§π‚àö)</span>
            </div>
        </div>
        <div class="chat-scroll" id="chat-list">
            <div class="sys-notice">V15.0 ÂÆâÂçìÂéüÁîü‰ΩìÈ™åÁâà</div>
        </div>
    </div>

    <div class="input-area-wrapper">
        <div class="input-bar">
            <button class="btn-circle" onclick="toggleInput()">‚å®Ô∏è</button>
            <button id="btn-voice" class="btn-voice">Êåâ‰Ωè ËØ¥ËØù</button>
            <input id="msg-input" type="text" placeholder="ËæìÂÖ•Ê∂àÊÅØ...">
            <button class="btn-circle" onclick="sendText()" id="btn-send" style="display:none; background:var(--primary); color:white;">‚û§</button>
            <button class="btn-circle" id="btn-plus" onclick="document.getElementById('file-input').click()">Ôºã</button>
        </div>
    </div>
    <input type="file" id="file-input" multiple style="display:none">

    <script>
        const App = { id: null, peer: null, conn: null, connected: false, queue: [], isSending: false };
        
        document.addEventListener('DOMContentLoaded', () => setTimeout(init, 100));

        function showToast(msg, type='normal') {
            const t = document.getElementById('toast');
            t.innerText = msg; t.className = type === 'error' ? 'error show' : 'show';
            setTimeout(() => t.className = '', 3000);
        }

        function init() {
            App.id = localStorage.getItem('sloth_v15') || (Math.floor(Math.random()*9000)+1000).toString();
            localStorage.setItem('sloth_v15', App.id);
            document.getElementById('my-id').innerText = App.id;
            const qr = document.getElementById("qr-code");
            if(qr && window.QRCode) new QRCode(qr, { text: App.id, width: 100, height: 100, colorDark: "#2D7CA8", colorLight: "#FFFFFF" });

            if(window.Peer) {
                App.peer = new Peer(App.id, { debug: 1 });
                App.peer.on('open', () => document.getElementById('status').innerText='Á≠âÂæÖËøûÊé•');
                App.peer.on('connection', c => { if(confirm('ËøûÊé• ID: '+c.peer+'?')) setupConn(c); });
                App.peer.on('error', e => { console.error(e); document.getElementById('status').innerText='ÈáçËøû‰∏≠...'; });
                setInterval(() => { if(App.conn && App.conn.open) App.conn.send({type:'ping'}); }, 3000);
            }
        }

        function setupConn(conn) {
            if(App.conn) App.conn.close(); App.conn = conn;
            conn.on('open', () => conn.send({ type: 'handshake' }));
            conn.on('data', handleData);
            conn.on('close', () => { App.connected=false; document.getElementById('status').innerText='Â∑≤Êñ≠ÂºÄ'; showToast('ËøûÊé•Êñ≠ÂºÄ', 'error'); });
        }
        function connect() { const t=document.getElementById('target-id').value.trim(); if(t) setupConn(App.peer.connect(t, {reliable:true})); }

        let Rx = { buf: [], size: 0, meta: null, lastLoaded: 0, lastTime: 0 };
        function handleData(data) {
            if (data.type) {
                if(data.type==='handshake'){ App.connected=true; document.getElementById('modal').style.display='none'; document.getElementById('status').innerText='Â∑≤ËøûÊé•'; document.getElementById('status').classList.add('online'); showToast('ËøûÊé•ÊàêÂäü'); }
                else if(data.type==='text') addMsg(data.text, 'peer');
                else if(data.type==='file-start') { Rx={buf:[],size:0,meta:data,lastLoaded:0,lastTime:Date.now()}; createFileItem(data.id, data.name, data.size, 'peer', data.mime); }
                else if(data.type==='file-end') finishFile(data.id, Rx.meta.mime);
            } else {
                Rx.buf.push(data); Rx.size += data.byteLength;
                const now = Date.now();
                if(now - Rx.lastTime > 500) {
                    const speed = calcSpeed(Rx.size - Rx.lastLoaded, now - Rx.lastTime);
                    updateProgress(Rx.meta.id, Rx.size, Rx.meta.size, speed);
                    Rx.lastLoaded = Rx.size; Rx.lastTime = now;
                }
            }
        }
        function calcSpeed(bytes, ms) { return ms<=0?'':(bytes/ms*1000 > 1048576 ? (bytes/ms*1000/1048576).toFixed(1)+' MB/s' : (bytes/ms*1000/1024).toFixed(0)+' KB/s'); }

        // --- Ê†∏ÂøÉ‰øÆÂ§çÔºöÊñá‰ª∂Â§πÈÄíÂΩí & ÊãñÊãΩ ---
        const dropCard = document.getElementById('drop-zone');
        let dragCounter = 0;

        document.addEventListener('dragenter', e => { e.preventDefault(); dragCounter++; dropCard.classList.add('drag-active'); });
        document.addEventListener('dragleave', e => { e.preventDefault(); dragCounter--; if(dragCounter===0) dropCard.classList.remove('drag-active'); });
        document.addEventListener('dragover', e => e.preventDefault());
        
        document.addEventListener('drop', async e => {
            e.preventDefault(); dragCounter = 0; dropCard.classList.remove('drag-active');
            const items = [...e.dataTransfer.items];
            let allFiles = [];
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.webkitGetAsEntry) {
                    const entry = item.webkitGetAsEntry();
                    if (entry) {
                        const files = await scanEntry(entry);
                        allFiles = allFiles.concat(files);
                    }
                } else if (item.kind === 'file') {
                    allFiles.push(item.getAsFile());
                }
            }
            if(allFiles.length) { showToast(`Ëß£ÊûêÂà∞ ${allFiles.length} ‰∏™Êñá‰ª∂`); enqueue(allFiles); }
        });

        // ÈÄíÂΩíÊâ´ÊèèÔºöÂÖ≥ÈîÆ‰øÆÂ§ç
        async function scanEntry(entry) {
            if (entry.isFile) {
                return new Promise(resolve => entry.file(file => resolve([file])));
            } else if (entry.isDirectory) {
                const reader = entry.createReader();
                const entries = await new Promise((resolve, reject) => {
                    reader.readEntries(resolve, reject);
                });
                let files = [];
                for (const subEntry of entries) {
                    files = files.concat(await scanEntry(subEntry));
                }
                return files;
            }
            return [];
        }

        document.getElementById('drop-zone').onclick = () => document.getElementById('file-input').click();
        document.getElementById('file-input').onchange = e => enqueue(e.target.files);

        function enqueue(files) {
            if(!App.connected) return showToast('ËØ∑ÂÖàËøûÊé•ËÆæÂ§á', 'error');
            Array.from(files).forEach(f => {
                const id = 'f-'+Date.now()+Math.random().toString(36).substr(2);
                createFileItem(id, f.name, f.size, 'self', f.type);
                App.queue.push({f, id});
            });
            process();
        }
        function process() { if(App.isSending || !App.queue.length) return; App.isSending=true; sendFile(App.queue.shift()); }
        
        function sendFile({f, id}) {
            App.conn.send({type:'file-start', id, name:f.name, size:f.size, mime:f.type});
            const reader = new FileReader(); let offset=0; let lastTime=Date.now(); let lastLoaded=0;
            const push = () => { if(App.conn.dataChannel.bufferedAmount > 65536) { setTimeout(push, 20); return; } const s = f.slice(offset, offset + 32768); reader.readAsArrayBuffer(s); };
            reader.onload = e => {
                App.conn.send(e.target.result); offset += e.target.result.byteLength;
                const now = Date.now();
                if(now - lastTime > 500 || offset >= f.size) {
                    const speed = calcSpeed(offset - lastLoaded, now - lastTime);
                    updateProgress(id, offset, f.size, speed);
                    lastLoaded = offset; lastTime = now;
                }
                if(offset < f.size) setTimeout(push, 0); else { App.conn.send({type:'file-end', id}); App.isSending=false; setTimeout(process, 100); }
            };
            push();
        }

        function createFileItem(id, name, size, who, mime) {
            const div = document.createElement('div'); div.className = `msg-row ${who}`; div.id = `msg-${id}`;
            let iconSvg = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>';
            div.innerHTML = `
                <div class="file-card">
                    <div class="file-inner">
                        <div class="thumb-box">${iconSvg}</div>
                        <div class="file-info">
                            <div class="file-name">${name}</div>
                            <div class="file-meta"><span>${(size/1024).toFixed(1)} KB</span> <span class="speed-tag"></span></div>
                            <div class="progress-bar"><div class="progress-fill"></div></div>
                        </div>
                    </div>
                    <button class="btn-preview">üëÅÔ∏è</button>
                </div>`;
            document.getElementById('chat-list').append(div);
            document.getElementById('chat-list').scrollTop = 99999;
        }
        function updateProgress(id, cur, tot, speed) {
            const el = document.getElementById(`msg-${id}`);
            if(el) { el.querySelector('.progress-fill').style.width = (cur/tot*100)+'%'; if(speed) el.querySelector('.speed-tag').innerText = speed; }
        }
        function finishFile(id, mime) {
            const el = document.getElementById(`msg-${id}`); if(!el) return;
            el.querySelector('.progress-bar').style.display='none'; el.querySelector('.speed-tag').innerText='ÂÆåÊàê';
            const url = URL.createObjectURL(new Blob(Rx.buf, {type: mime})); Rx.buf = [];
            const inner = el.querySelector('.file-inner'), thumbBox = el.querySelector('.thumb-box'), btnPreview = el.querySelector('.btn-preview');
            
            // ÁÇπÂáªÊñá‰ª∂‰∏ª‰ΩìÔºö‰∏ãËΩΩ
            inner.onclick = () => { const a=document.createElement('a'); a.href=url; a.download='file'; a.click(); };

            if (mime.includes('image')) {
                thumbBox.innerHTML = `<img src="${url}" class="thumb-img">`; btnPreview.style.display = 'flex';
                btnPreview.onclick = (e) => { e.stopPropagation(); openLightbox(url, 'img'); };
            } else if (mime.includes('video')) {
                const video = document.createElement('video'); video.src = url; video.currentTime = 1; video.className = 'thumb-img';
                thumbBox.innerHTML = ''; thumbBox.appendChild(video);
                btnPreview.innerHTML = '‚ñ∂'; btnPreview.style.display = 'flex';
                btnPreview.onclick = (e) => { e.stopPropagation(); openLightbox(url, 'video'); };
            }
        }

        // --- Ê†∏ÂøÉ‰øÆÂ§çÔºöHistory API Êé•ÁÆ°ÂÆâÂçìËøîÂõûÈîÆ ---
        function openLightbox(url, type) {
            // Êé®ÂÖ•ÂéÜÂè≤Áä∂ÊÄÅÔºåËøôÊ†∑Êåâ‰∏ãËøîÂõûÈîÆÊó∂ÔºåÂè™ÊòØÂõûÈÄÄËøô‰∏™Áä∂ÊÄÅÔºåËÄå‰∏çÊòØÈÄÄÂá∫App
            history.pushState({modal: 'lightbox'}, '', '#preview');
            
            const lb=document.getElementById('lightbox'), img=document.getElementById('lb-img'), vid=document.getElementById('lb-video');
            img.style.display='none'; vid.style.display='none'; lb.classList.add('active');
            if(type==='img') { img.src=url; img.style.display='block'; } else { vid.src=url; vid.style.display='block'; vid.play(); }
        }

        // ÁõëÂê¨Á≥ªÁªüËøîÂõûÈîÆ (popstate)
        window.addEventListener('popstate', (e) => {
            // ÂΩìÂéÜÂè≤Áä∂ÊÄÅÂºπÂá∫Êó∂ÔºàÂç≥Êåâ‰∏ãËøîÂõûÈîÆÔºâÔºåÂÖ≥Èó≠ UI
            const lb = document.getElementById('lightbox');
            lb.classList.remove('active');
            const vid = document.getElementById('lb-video');
            vid.pause();
        });

        // ÊåâÈíÆ‰∏ªÂä®ÂÖ≥Èó≠Êó∂ÔºåÈúÄË¶ÅÊâãÂä® history.back() ‰ª•‰øùÊåÅÂéÜÂè≤Ê†àÊ∏ÖÊ¥Å
        window.triggerClose = () => {
            history.back(); // Ëøô‰ºöËß¶Âèë‰∏äÈù¢ÁöÑ popstate ‰∫ã‰ª∂Ôºå‰ªéËÄåÂÖ≥Èó≠ UI
        };

        const bVoice=document.getElementById('btn-voice'); let mRec, chunks=[];
        const startR=async e=>{e.preventDefault();if(!App.connected)return;try{const s=await navigator.mediaDevices.getUserMedia({audio:true});mRec=new MediaRecorder(s);chunks=[];mRec.ondataavailable=e=>chunks.push(e.data);mRec.onstop=()=>enqueue([new File([new Blob(chunks)],"voice.webm",{type:'audio/webm'})]);mRec.start();bVoice.classList.add('recording');bVoice.innerText="ÊùæÂºÄ ÂèëÈÄÅ";}catch(e){showToast("È∫¶ÂÖãÈ£éÈîôËØØ", 'error');}};
        const stopR=e=>{e.preventDefault();if(mRec)mRec.stop();bVoice.classList.remove('recording');bVoice.innerText="Êåâ‰Ωè ËØ¥ËØù";}
        ['touchstart','mousedown'].forEach(k=>bVoice.addEventListener(k,startR)); ['touchend','mouseup'].forEach(k=>bVoice.addEventListener(k,stopR));
        window.toggleInput=()=>{const t=document.getElementById('msg-input'), v=document.getElementById('btn-voice'), s=document.getElementById('btn-send'), p=document.getElementById('btn-plus'); if(t.style.display==='none'){t.style.display='block';v.style.display='none';s.style.display='block';p.style.display='none';t.focus();}else{t.style.display='none';v.style.display='flex';s.style.display='none';p.style.display='flex';}};
        window.sendText=()=>{const v=document.getElementById('msg-input').value;if(v){App.conn.send({type:'text',text:v});addMsg(v,'self');document.getElementById('msg-input').value='';}};
        function addMsg(t,w){const d=document.createElement('div');d.className=`msg-row ${w}`;d.innerHTML=`<div class="bubble">${t}</div>`;document.getElementById('chat-list').append(d);document.getElementById('chat-list').scrollTop=99999;}
        let qr; window.toggleScan=()=>{const s=document.getElementById('scanner-box');if(s.style.display==='block'){s.style.display='none';if(qr)qr.stop();}else{s.style.display='block';qr=new Html5Qrcode("reader");qr.start({facingMode:"environment"},{fps:10},t=>{document.getElementById('target-id').value=t;toggleScan();});}};
    </script>
</body>
</html>
